import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/src/widgets/framework.dart';
import 'package:happyhaunting/Data/Database/DatabaseStructure/11_Expansion.dart';
import 'package:happyhaunting/Data/Database/Enums/UI/Frame/FrameType.dart';
import 'package:happyhaunting/Data/Database/Getters/DatabaseChapter_Getter.dart';
import 'package:happyhaunting/GameScrens/GlobalCode/GUI/AnimatedContainer/AnimatedContainer_Getter.dart';
import 'package:happyhaunting/GameScrens/GlobalCode/GUI/Buttons/Button_GUI.dart';
import 'package:happyhaunting/GameScrens/GlobalCode/GUI/DedicatedArea/DedicatedArea_GUI.dart';
import 'package:happyhaunting/GameScrens/GlobalCode/GUI/FramedWindow/FramedWindow_GUI.dart';
import 'package:happyhaunting/GameScrens/GlobalCode/GUI/Text/TextAndFont.dart';
import 'package:happyhaunting/GameScrens/LevelPicker/ChapterPicker/ChapterPicker_GUI.dart';
import 'package:happyhaunting/GameScrens/LevelPicker/MapPicker/MapPicker_GUI.dart';
import 'package:happyhaunting/GameScrens/LevelPicker/Template/Elements/PlotTraits_GUI.dart';
import 'package:happyhaunting/GameScrens/LevelPicker/Template/LevelPickerTemplateBackground.dart';
import 'package:happyhaunting/ViewModels/Selector/Level/LevelSelector_ViewModel.dart';
import 'package:hive/hive.dart';
import 'package:provider/provider.dart';

class ExpansionPicker_GUI{
  static getExpansionPickerBox(BuildContext context, double width, double height) {

    var box_Expansion = Hive.box<Expansion>('expansions');
    LevelSelector_ViewModel levelSelector_ViewModel = context.read<LevelSelector_ViewModel>();

    double entyWidth = width;
    double entryHeight = height * 0.4;
    double entryHeight_Activated = height * 1;
    double entryPadding = entryHeight * 0.03;

    int itemCount = box_Expansion.length;

    return Container(
      height: height, width: width, //color: Colors.green,
      child: Stack(
        alignment: Alignment(0, 0),
        children: [
            ListView.builder(
              itemCount: itemCount,
              itemBuilder: (context, index){
              Expansion? expansion = box_Expansion.getAt(index);
              if(expansion == null) return Container();
              bool isThisExpansionChosen = levelSelector_ViewModel.chosenExpansion?.id == expansion.id;
              double newHeight = isThisExpansionChosen ? entryHeight_Activated : entryHeight;

              return Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  AnimatedContainer(
                    duration: AnimatedContainer_Getter.getDuration(),
                    curve: AnimatedContainer_Getter.getCurve(),
                    height: newHeight, width: entyWidth,
                    child: FramedWindow_GUI.getFramedWindow(context, entyWidth, newHeight,
                        frameType: FrameType.Gold,
                        function: () => getExpansionBox(context, entyWidth, newHeight, expansion, entryHeight),
                    ),
                  ),
                  Padding(padding: EdgeInsets.only(top: entryPadding)),
                ],
              );
            })
        ],
      ),
    );
  }

  static getExpansionBox(BuildContext context, double width, double height, Expansion expansion, double defaultHeight) {

    LevelSelector_ViewModel levelSelector_ViewModel = context.read<LevelSelector_ViewModel>();
    bool isExpansionChosen = levelSelector_ViewModel.chosenExpansion?.id == expansion.id;
    bool isChapterChosen = levelSelector_ViewModel.chosenChapter != null;

    double padding = defaultHeight * 0.1;
    //LEFT SIDE
    double descriptionHeight = defaultHeight * 0.6;
    double chapterPickerHeight = height - descriptionHeight - padding * 2;
    double leftSideWidth = width * 0.325;
    double topPadding_ChapterPicker = isExpansionChosen ? padding : padding - chapterPickerHeight * 2;

    //RIGHT SIDE
    double levelPickerHeight = height - 2 * padding;
    double levelPickerWidth = width - leftSideWidth - padding * 3;
    double topPadding_LevelPicker = isChapterChosen ? padding : padding - levelPickerHeight * 1.25;

    //TITLE AND DIVIDER
    double titleHeight = height * 0.125;
    double dividerHeight = height * 0.05;
    double dividerWidthModifier = 0.8;


    // double circleSize = defaultHeight * 0.6;
    // double circleTitle = defaultHeight * 0.15;
    // double circleBoxPadding = width * 0.025;

    return Container(
      height: height, width: width,
      child: GestureDetector(
        onTap: (){
          // if(levelSelector_ViewModel.chosenExpansion?.id != expansion.id){
          //     levelSelector_ViewModel.clear();
          //     levelSelector_ViewModel.setChosenExpansion(expansion);
          // }
          if(levelSelector_ViewModel.chosenExpansion?.id == expansion.id){
            levelSelector_ViewModel.clear();
          } else {
            levelSelector_ViewModel.clear();
            levelSelector_ViewModel.setChosenExpansion(expansion);
          }

        },
        child: Stack(
          alignment: Alignment(0, 0),
          children: [
            LevelPickerTemplateBackground.getBackground(width, height, expansion.backgroundImage, 'UI/ExpansionPicker/'),
            //DESCRIPTION
            Positioned(
              bottom: padding, left: padding,
              child: TextAndFont.getText(leftSideWidth, descriptionHeight,
                  expansion.description,
                  // fontSize: descriptionHeight * 0.25,
                  alignment: Alignment.bottomLeft
              )
            ),

            //CHAPTER PICKER
            AnimatedPositioned(
                duration: AnimatedContainer_Getter.getDuration(),
                top: topPadding_ChapterPicker, left: padding,
                child: ChapterPicker_GUI.getChapterPickerBox(context, expansion, chapterPickerHeight, leftSideWidth,
                    titleHeight, dividerHeight, dividerWidthModifier
                )
            ),

            //LEVEL PICKER
            if(levelSelector_ViewModel.chosenExpansion?.id == expansion.id)
            AnimatedPositioned(
                duration: AnimatedContainer_Getter.getDuration(),
                top: topPadding_LevelPicker, right: padding,
                child: MapPicker_GUI.getMapPickerBox(context,
                    levelPickerHeight, levelPickerWidth,
                    titleHeight, dividerHeight, dividerWidthModifier,
                    isChapterChosen
                )
            ),


            // Positioned(
            //     right: circleBoxPadding,
            //     child: PlotTraits_GUI.getPlotTraitsBox(circleSize, circleTitle, expansion: expansion)
            // )
          ],
    ),
      ),
    );

  }

}